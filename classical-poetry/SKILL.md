---
name: classical-poetry
description: 创建古典汉诗（律诗/绝句/排律、词、曲、对联）。适用于生成或修正符合特定主题、体裁或韵律的诗词曲对联。
---

# 古典诗词创作工作流

本技能通过结构化流程指导你创作古典诗词（诗/词/曲/对联），并进行格律和韵律验证。工作流程：需求收集 → 意象采集 → 起草 → 格律验证 → 修改润色。

## 路径约定

**SKILL_ROOT 定义：**
- **Claude Code 用户**：`SKILL_ROOT="$HOME/.claude/skills/classical-poetry"`
- **其他环境用户**：首次使用时询问 skill 安装路径，记录为 `SKILL_ROOT`，整个会话复用

所有脚本调用使用格式：`python3 $SKILL_ROOT/scripts/xxx.py`

## 语言要求

**IMPORTANT: 全程使用中文与用户交流。**所有阶段说明、问题询问、结果呈现都必须使用中文。

## 何时触发此工作流

**触发条件：**
- 用户要求创作古典诗词："写一首诗"、"create a poem"、"作诗"
- 用户提到具体体裁："五言绝句"、"七律"、"词"、"对联"
- 用户要求验证已有诗词："check this poem"、"这首诗格律对吗"
- 用户提供主题并要诗："写一首关于中秋的诗"

**初始应答：**
用中文向用户介绍结构化创作流程，说明包含以下阶段：

1. **需求收集**：确定体裁、格式、韵书、主题
2. **意象采集**：从古典诗词中提取相关意象词汇
3. **起草创作**：运用意象和结构创作诗词
4. **格律验证**：自动检查平仄、韵律、对仗
5. **修改润色**：修正问题并优化诗词

用中文说明这能确保诗词符合古典格律规则。询问用户是否使用此流程，还是自由创作。

如果用户拒绝，则自由创作。如果用户同意，进入第一阶段。

## 第一阶段：需求收集

**目标：** 准确了解要创作的诗词类型和约束条件。

### 初始问题

**用中文**向用户询问具体需求（如果用户已在请求中说明部分需求，则只询问缺失的信息）：

1. **体裁**：诗、词、曲，还是对联？
   - 如果已知是诗，询问：五言绝句、七言绝句、五言律诗、七言律诗，还是排律？
   - 如果已知是词，询问：词牌名是什么？（例如：水调歌头、念奴娇、定风波）
   - 如果已知是曲，询问：曲牌名是什么？（例如：天净沙）
   - 如果是对联，询问：上下联各多少字？

2. **韵书选择**（必须明确询问，不使用默认值）：
   - 对于**诗**或**对联**，用中文询问：
     ```
     请选择韵书：
     1. 平水韵（传统韵书，保留入声，适合古体诗）
     2. 中华新韵（现代韵书，基于普通话，无入声）
     3. 中华通韵（兼容传统与现代）
     ```
   - 对于**词**，用中文询问：
     ```
     请选择韵书：
     1. 平水韵（传统韵书，保留入声）
     2. 词林正韵（专门用于词的韵书，保留入声）
     3. 中华新韵（现代韵书，无入声）
     ```
   - 对于**曲**，用中文询问：
     ```
     请选择韵书：
     1. 平水韵（传统韵书，保留入声）
     2. 中华新韵（现代韵书，无入声）
     3. 中华通韵（兼容韵书）
     ```

   **记录用户选择的韵书编号和名称，用于后续验证。**

   **重要说明 - 关于入声：**

   在古汉语中，汉字分为**平、上、去、入**四声。入声字在古音中为促音，归入仄声。但在现代普通话中，入声已消失，入声字分派到了平上去三声。

   **入声的影响：**
   - **平水韵**：保留入声，入声字属于仄声
     - 例如："一、百、客、国、白、北、黑、得、曲、竹、足、局、**皆**"等都是入声字
     - 在平水韵中，这些字都算仄声，即使在普通话中读平声

   - **中华新韵**：以普通话为准，无入声概念
     - 按现代发音：阴平、阳平为平声；上声、去声为仄声
     - 例如："皆"（jiē，第一声）在中华新韵中为平声

   **选择建议：**
   - 创作古风诗词，追求古典韵味 → 选择**平水韵**或**词林正韵**
   - 现代诗词创作，符合现代发音 → 选择**中华新韵**
   - 不确定时，古体诗词建议选择**平水韵**（更传统）

3. **语言文字**：简体字还是繁体字？（如未说明可询问，或默认简体字）

4. **主题**：诗词的主题是什么？（如用户已说明则跳过）

5. **意境风格**：有无特定的情感基调或意象偏好？（可选）

### 韵书映射表（供内部使用）

记录用户选择的韵书，在验证阶段使用对应的参数：

| 韵书名称 | validation时的 --yun-shu 参数 |
|---------|------------------------------|
| 平水韵   | 1                            |
| 中华新韵 | 2                            |
| 中华通韵 | 3                            |
| 词林正韵 | 1（注：词林正韵使用平水韵的平仄系统） |

**退出条件：**
已明确：体裁、格式、主题、韵书选择。

**过渡：**
用中文向用户确认需求。例如：
```
好的，我将为您创作一首关于中秋的七言律诗，使用平水韵，简体字。
现在开始收集意象素材。
```

进入第二阶段。

## 第二阶段：意象采集

**目标：** 从古典诗词中提取与主题相关的意象词汇，确保作品具有古典风格。

### 意象搜索

用中文告知用户："正在收集与「[主题]」相关的古典意象..."

使用 `reference_builder.py` 获取相关古典诗词：

```bash
python3 $SKILL_ROOT/scripts/reference_builder.py \
  --keyword "[主题]" --pages 2 --scope Sentence --top 30 \
  --out "/tmp/poetry_refs.json"
```

**重要：** 只提取意象词汇（意象）和高频词，**不要**使用完整诗句。这能避免抄袭，同时获得古典词汇。

### 意象分析

从搜索结果中：
1. 识别常见意象模式（例如中秋：月、思乡、桂花、玉兔）
2. 注意常用字词的平仄特征
3. 考虑季节和情感关联

用中文向用户简要说明收集到的核心意象（3-5个即可），例如：
```
已收集到核心意象：明月、千里、秋夜、桂花、思乡
```

**如果意象搜索不可用：**
从古典诗词通用知识中提取该主题的常见意象。

**退出条件：**
已获得 15-30 个相关意象词汇。

**过渡：**
用中文告知："意象收集完成，开始创作诗词。"

进入第三阶段。

## 第三阶段：起草创作

**目标：** 运用正确的结构和古典意象创作诗词。

### 创作指南

**对于诗：**
- 注意字数（五言：5字/句，七言：7字/句）
- 规划押韵位置（绝句：第2、4句押韵；律诗：第2、4、6、8句押韵）
- 自然运用意象词汇
- 绝句遵循"起承转合"结构

**对于词：**
- 必须符合词牌的字数格式（每句字数）
- 押韵位置取决于具体词牌
- 某些位置可能需要特定平仄

**对于曲：**
- 遵循曲牌格律（如已指定）
- 比词更灵活，允许衬字

**对于对联：**
- 上下联平仄相对
- 需要语义对仗
- 上联末字仄声，下联末字平声

### 创作流程

1. 基于需求和意象词汇起草完整诗词
2. 用中文向用户呈现初稿，例如：
   ```
   初稿如下：

   [诗词内容]

   现在进行格律验证...
   ```
3. 立即进入验证阶段（第四阶段），**不要**等待用户确认

**不要**询问"初稿是否可以"——格律验证会客观揭示问题。

## 第四阶段：格律验证

**目标：** 使用自动工具检查平仄、韵律、对仗。

### 执行验证

**重要：使用第一阶段记录的韵书参数。**

根据体裁运行对应的检查器：

**对于诗：**
```bash
python3 $SKILL_ROOT/scripts/poetry_checker.py \
  --mode shi --text "[诗词文本]" --yun-shu [用户选择的韵书编号] [--trad如果是繁体]
```

**对于词：**
```bash
python3 $SKILL_ROOT/scripts/poetry_checker.py \
  --mode ci --text "[词文本]" --ci-pai "[词牌名]" \
  --ci-pu [1|2] --yun-shu [用户选择的韵书编号] [--trad如果是繁体]
```

注：
- `--ci-pu 1` = 钦定词谱（默认）
- `--ci-pu 2` = 龙榆生词谱
- 如果用户选择了"词林正韵"，使用 `--yun-shu 1`（词林正韵使用平水韵的平仄系统）

**对于曲：**
```bash
python3 $SKILL_ROOT/scripts/poetry_checker.py \
  --mode qu --text "[曲文本]" --qu-pai "[曲牌名]" \
  --yun-shu [用户选择的韵书编号] [--trad如果是繁体]
```

**对于对联：**
```bash
python3 $SKILL_ROOT/scripts/poetry_checker.py \
  --mode couplet --upper "[上联]" --lower "[下联]" \
  --yun-shu [用户选择的韵书编号] [--auto-suggest]
```

### 结果解读

用中文向用户解释验证结果：

验证工具输出符号含义：
- **〇** = 平仄正确
- **●** = 平仄错误（需要修改）
- **◎** = 多音字（需要根据上下文验证读音）
- **�** = 无法识别的字符

**特别注意 - 入声字识别：**

如果使用**平水韵**或**词林正韵**（--yun-shu 1），需要注意入声字的处理：

常见入声字（仄声）包括但不限于：
- 数字：一、七、八、十、百
- 方位：北、南、东
- 动词：得、说、出、入、识、别、**皆**
- 名词：国、客、白、黑、竹、足、物、曲

**验证方法：**
如果对某个字的平仄有疑问，可以：
1. 检查是否为入声字（工具应已标识）
2. 查阅《平水韵》或《词林正韵》确认
3. 如果工具未正确识别入声字，请**明确告知用户**：
   ```
   注意：「皆」字在平水韵中为入声字（仄声），
   但在普通话中读 jiē（第一声），容易误判为平声。
   工具应将其识别为仄声。
   ```

用中文总结验证结果，例如：
```
格律验证完成：
- 词牌：水调歌头
- 韵书：平水韵（保留入声）
- 韵部：东韵
- 押韵：符合词谱要求
- 平仄：第3句第4字「皆」为入声字（仄声），格律正确
```

**退出条件：**
- 如果验证通过（全部 〇 标记）：进入第五阶段做最后确认
- 如果验证失败（有任何 ● 或 ◎ 标记）：进入修改润色循环

## 第五阶段：修改润色

**目标：** 修正平仄问题并润色诗词，同时保持原意和意象。

### 修正平仄问题

对每个 ● 或 ◎ 标记的位置：

1. **识别问题**：哪个字违反了平仄格律？
2. **寻找替代字**：可使用 `scripts/souyun_api.py` 查找正确平仄的字词
3. **考虑意义**：选择能保留或增强意义的替代字
4. **检查多音字**：验证多音字在上下文中的正确读音

用中文说明修改内容，例如：
```
修改建议：
第3句第2字「看」应为仄声，可改为「望」
```

### 对联的自动建议

对于对联，可使用 `--auto-suggest` 自动生成替代字：

```bash
python3 $SKILL_ROOT/scripts/poetry_checker.py \
  --mode couplet --upper "[上联]" --lower "[下联]" \
  --yun-shu [用户选择的韵书编号] --auto-suggest
```

工具会为不匹配的位置建议替换字。

### 润色流程

1. 进行针对性的字词替换
2. 重新运行验证
3. 如果出现新问题，重复修改
4. 验证通过后，用中文向用户呈现修改后的版本

**重要原则：**
- 只修改必要的地方以符合格律
- 保留核心意象和意义
- 保持自然流畅的语感

### 允许用户调整

呈现修改后的版本后，用中文询问：
```
格律验证已通过。您是否需要调整某些字词的意义或意象？
```

- 如果用户要求修改，进行调整并重新验证
- 迭代直到用户满意

**退出条件：**
验证通过**且**用户认可内容。

## 第六阶段：最终交付

**目标：** 呈现完成的诗词及验证报告。

### 呈现格式

用中文呈现最终诗词：

1. **完整诗词文本**（格式清晰）
2. **格律总结**，例如：
   ```
   【格律验证】
   - 诗体：七言律诗
   - 韵书：平水韵
   - 韵部：尤韵
   - 韵脚：楼、流、愁、秋、头
   - 格律：符合平仄要求
   ```
3. **平仄格式**（可选，仅在用户要求时显示详细格式）
4. **意象说明**（如使用了典故或特殊意象，简要说明）

### 可选内容

用中文询问是否需要：
- 意象和典故解释
- 拼音或读音指导
- 白话文翻译或英文翻译
- 书法排版格式

**完成确认：**
用中文确认创作完成：
```
诗词创作完成。您是否需要：
1. 调整某些内容
2. 创作另一首诗词
3. 其他需求
```

## 技术参考

### 参考文档

详细文档请参考：
- `references/souyun_api.md` - 搜韵API接口，用于韵字查询和对仗词建议
- `references/qu_patterns.md` - 曲牌格律模板
- `scripts/` 目录中的脚本自动处理验证

### 核心脚本

- `scripts/poetry_checker.py` - 主验证工具，支持所有体裁
- `scripts/reference_builder.py` - 按主题获取古典诗词参考
- `scripts/souyun_api.py` - 在线韵书查询辅助函数
- `scripts/review_pipeline.py` - 自动验证和审查工作流

### 配置说明

**韵书编号（yun-shu参数）：**
- 1 = 平水韵（保留入声，入声字为仄声）
- 2 = 中华新韵（无入声，按普通话四声）
- 3 = 中华通韵（兼容韵书）
- 词林正韵 = 使用参数1（基于平水韵的平仄系统，保留入声）

**词谱选择（ci-pu参数）：**
- 1 = 钦定词谱（默认）
- 2 = 龙榆生词谱

### 常见入声字速查表（平水韵）

**数字类：** 一、七、八、十、百、千

**方位类：** 北、南（部分读音）

**动词类：** 得、说、出、入、识、别、接、接、切、结、节、决、绝、灭、歇、杀、发、发（fā）、活、割、达、夺、脱、失、质、察、插、刷

**名词类：** 国、客、白、黑、竹、足、目、物、曲、局、玉、福、宅、席、额、格、隔、核、壳、月、雪、铁、热、节、血、别、叶、业

**形容词类：** 急、湿、窄、阔、薄、厚、直、曲

**常用入声字：**
- **皆** - jiē，第一声，普通话为平声，平水韵为入声（仄声）
- **得** - dé/děi/de，平水韵为入声（仄声）
- **一** - yī，第一声，平水韵为入声（仄声）
- **白** - bái，第二声，平水韵为入声（仄声）
- **国** - guó，第二声，平水韵为入声（仄声）

**注意：** 使用平水韵（--yun-shu 1）时，以上所有字都应识别为仄声。如果工具识别错误，需要明确告知用户并建议替换字词。

### Python 环境要求

**Python 检测优先级（按顺序）：**

1. **项目特定 Python**（最高优先级）

   如果项目的 `CLAUDE.md` 文件中指定了 Python 路径，使用该路径：
   ```markdown
   ## Environment
   - Python: `~/.uv/python3/bin/python`
   ```

   **使用场景：**
   - 使用 uv、pyenv、conda 管理多个 Python 版本
   - 项目特定的虚拟环境
   - 非系统级 Python 安装

2. **系统 Python**（默认）

   如果没有项目特定配置，使用标准命令：
   ```bash
   python3 $SKILL_ROOT/scripts/poetry_checker.py
   ```

3. **找不到 Python 时的处理**

   当第一次调用脚本失败时，用中文告知用户：
   ```
   检测到您的系统中未找到 Python 3。

   本技能需要 Python 3 来运行格律验证工具。

   选项 1：如果您已安装 Python 3，请告诉我完整路径（例如：/usr/local/bin/python3）

   选项 2：如果尚未安装，建议通过以下方式安装：
   - macOS: brew install python3
   - Ubuntu/Debian: sudo apt install python3
   - Windows: 从 python.org 下载安装

   选项 3：如果您使用 uv 等工具管理 Python，可以在项目的 CLAUDE.md 中指定：
   ## Environment
   - Python: `~/.uv/python3/bin/python`
   ```

**检测流程：**
1. 检查项目 CLAUDE.md 是否有 Python 配置 → 使用配置的路径
2. 尝试 `python3` 命令 → 如果可用则使用
3. 尝试 `python` 命令（验证是否为 Python 3.x）→ 如果是则使用
4. 询问用户提供路径 → 使用用户提供的路径

**会话缓存：** 找到可用的 Python 命令后，在整个会话中复用，不重复检测。

## 创作技巧

**工作流程建议：**
- 不要急于求成——古典诗词需要多次验证迭代
- 对于平仄格律，信任自动检查器而非直觉
- 使用意象搜索确保古典韵味的真实性

**常见问题：**
- **入声字误判**：最常见问题！
  - 现象：在普通话中读平声的字，在平水韵中可能是入声（仄声）
  - 常见入声字：一、七、八、十、百、得、说、出、入、北、白、黑、竹、足、国、客、**皆**、**物**、**曲**等
  - 解决：使用平水韵时，这些字应按仄声处理
  - 验证：如果工具未正确识别，需要手动确认并告知用户

- **多音字**：根据上下文验证读音是否正确
  - 例如："长"（cháng/zhǎng）、"还"（hái/huán）、"为"（wéi/wèi）

- **孤平问题**：通常只需修改一个字即可解决
  - 七言：除韵脚外，句中只有一个平声字
  - 五言：除韵脚外，句中没有平声字

- **押韵不合**：使用搜韵API查找同韵的替代字

**质量标准：**
- 在格律约束下仍保持自然流畅
- 意象生动切合主题
- 具有情感共鸣和意境
- 没有为凑格律而生硬造句

**高级用法：**
- 律诗的对仗（对仗）虽有自动检查，但可手工精修
- 考虑使用典故增加诗词深度
- 词和曲的平仄格律通常比诗更灵活
